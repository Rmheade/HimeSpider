<!DOCTYPE html>

<html>
<head>
<script>
      // Domain whitelist - only allow running on studying.work.gd
      const ALLOWED_DOMAINS = ['studying.work.gd', 'rmheade.github.io'];
      
      function checkDomain() {
        try {
          if (window.self === window.top) {
            window.location.href = 'https://studying.work.gd/';
            return false;
          }

          const referrer = document.referrer;
          if (!referrer) {
            window.location.href = 'https://studying.work.gd/no.html';
            return false;
          }

          const parentHost = new URL(referrer).hostname;
          const isAllowed = ALLOWED_DOMAINS.some(domain => 
            parentHost === domain || parentHost.endsWith('.' + domain)
          );

          if (!isAllowed) {
            window.location.href = 'https://studying.work.gd/no.html';
            return false;
          }
          return true;
        } catch (e) {
          window.location.href = 'https://studying.work.gd/no.html';
          return false;
        }
      }

      if (!checkDomain()) {
        throw new Error('Domain security check failed');
      }
 // Listen for tilde key from parent window
      window.addEventListener("message", (event) => {
        if (event.data && event.data.type === "tilde-pressed") {
          window.parent.postMessage({ type: "tilde-pressed" }, "*");
        }
      });
      
      // Send tilde key press to parent window
      document.addEventListener("keydown", (e) => {
        if (e.key === "`") {
          window.parent.postMessage({ type: "tilde-pressed" }, "*");
          window.location.href = 'https://studying.work.gd/';
        }
      });
      
      // Listen for the Escape key press
      document.addEventListener('keydown', (event) => {
          // Check if the key pressed is the Escape key
          if (event.key === 'Escape') {
              // Send a message to the parent window (the main dashboard)
              // The main page will listen for this signal and close the game iframe
              if (window.parent) {
                  window.parent.postMessage('closeGame', '*');
              }
          }
        });
    </script>
<title>Choose a File</title>

<style>
    .watermark-box {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 15px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-family: sans-serif;
        font-size: 14px;
        border-radius: 5px;
        z-index: 9999;
        pointer-events: auto;
        transition: opacity 0.3s ease;
    }
    .watermark-box:hover {
        opacity: 0;
        pointer-events: none;
    }
</style>
</head>
<body>
<h2>I'm supposed to be an invisible iframe... (you shouldn't see this)</h2>
<script src="https://www.dropbox.com/static/api/2/dropins.js"></script>
<script src="https://js.live.net/v7.2/OneDrive.js"></script>
<script src="tokens.js"></script>
<script>
		var queries = Object.fromEntries(window.location.search.substring(1).split("&").map(i => i.split("=")).map(i => i.map(i => i && decodeURIComponent(i))));
		
		var fileTypes = queries.exts ? queries.exts.split(",") : [];
		
		function finish(message, name, data) {
			window.parent.postMessage({webretro: {timestamp: parseInt(queries.timestamp), message: message, name: name, data: data}}, "*");
		}
		
		function xhr(loc, success, error) {
			var xhr = new XMLHttpRequest();
			xhr.open("GET", loc, true);
			xhr.responseType = "arraybuffer";
			xhr.onload = function() {
				success(this.response);
			}
			xhr.onerror = function(e) {
				if (error) error(e);
			}
			xhr.send();
		}
		
		// Pass on data from Google Drive picker
		window.addEventListener("message", function(e) {
			if (e.origin == window.location.origin && e.data.webretro) finish(e.data.webretro.message, e.data.webretro.name, e.data.webretro.data);
		}, false);
		
		if (queries.type == "drive") {
			// Google Drive
			
			var dwidth = window.screen.width - 320;
			var dheight = window.screen.height - 240;
			var dleft = 160;
			var dtop = 120;
			window.open("drive.html?exts=" + fileTypes.join(","), "Choose a File", "left=" + dleft + ",top=" + dtop + ",width=" + dwidth + ",height=" + dheight);
		} else if (queries.type == "dropbox") {
			// Dropbox
			
			Dropbox.appKey = dropboxAppKey;
			Dropbox.choose({
				success: function(files) {
					var file = files[0];
					xhr(file.link, function(data) {
						finish("success", file.name, data);
					}, function() {
						finish("error");
					});
				},
				cancel: function() {
					finish("cancelled");
				},
				linkType: "direct",
				multiselect: false,
				folderselect: false
			});
		} else if (queries.type == "onedrive") {
			// OneDrive
			
			OneDrive.open({
				clientId: onedriveClientId,
				action: "download",
				multiSelect: false,
				advanced: {
					filter: fileTypes.join(",")
				},
				success: function(response) {
					var name = response.value[0].name;
					var link = response.value[0]["@microsoft.graph.downloadUrl"];
					xhr(link, function(data) {
						finish("success", name, data);
					}, function() {
						finish("error");
					});
				},
				cancel: function() {
					finish("cancelled");
				},
				error: function(error) {
					finish("error");
				}
			});
		}
		</script>

<div class="watermark-box">
    studying.work.gd
</div>
</body>
</html>